<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Î‘Î½Î¬Î»Ï…ÏƒÎ·Ï‚ Î Î±ÏÎ±Î³ÏÎ¬Ï†Î¿Ï… - Î‘' Î›Ï…ÎºÎµÎ¯Î¿Ï…</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 16px;
            line-height: 1.6;
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .header h1 { font-size: 1.5rem; color: #1e293b; }
        .header-subtitle { color: #64748b; font-size: 0.875rem; }
        
        .question-counter { text-align: right; }
        .question-counter span {
            font-size: 1.75rem;
            font-weight: 700;
            color: #4f46e5;
        }

        /* ---- ÎŸÎ›ÎŸ Ï„Î¿ CSS ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Î±Ï…Ï„Î¿ÏÏƒÎ¹Î¿ ---- */
    </style>
</head>

<body>
    <div class="container" id="app">
        <div class="card loading">
            <div class="loading-spinner"></div>
            <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</p>
        </div>
    </div>

<script>
/* =====================================================
   Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£
===================================================== */

const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTH8nczzu7hQKzQrz4ndfbiFsryk-5XUZ9Wn8tx6mOuW3FBXNyD2U0CCS22sh6Pj0pkRfFNk4rLjDnK/pub?output=csv';

const tropoiAnaptyxis = [
    "Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î±",
    "Î‘Î¹Ï„Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ·", 
    "Î‘Î¯Ï„Î¹Î¿-Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±",
    "Î”Î¹Î±Î¯ÏÎµÏƒÎ·",
    "Î£ÏÎ³ÎºÏÎ¹ÏƒÎ·-Î±Î½Ï„Î¯Î¸ÎµÏƒÎ·",
    "Î‘Î½Î±Î»Î¿Î³Î¯Î±",
    "ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚"
];

let allData = [];
let quizData = [];

/* =====================================================
   STATE (ÎœÎŸÎÎ— Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: stats)
===================================================== */

let state = {
    screen: 'loading',
    selectedDomiFilter: 'all',
    selectedTroposFilter: 'all',
    selectedCount: 10,
    selectedDifficulty: 'all',

    currentQuestion: 0,
    selectedDomi: null,
    selectedTropoi: [],
    showResult: false,

    score: {
        domi: 0,
        tropiKyrios: 0,
        tropiDeytereyon: 0
    },

    stats: {
        domiErrors: 0,
        kyriosErrors: {},
        deytereyonErrors: 0
    },

    showTheory: false
};

/* =====================================================
   DATA LOADING
===================================================== */

function parseCSVLine(line, delimiter) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === delimiter && !inQuotes) {
            result.push(current);
            current = '';
        } else current += char;
    }
    result.push(current);
    return result.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
}

function detectDelimiter(firstLine) {
    return (firstLine.match(/;/g) || []).length >
           (firstLine.match(/,/g) || []).length ? ';' : ',';
}

function parseCSV(csv) {
    const lines = csv.split('\n').filter(l => l.trim());
    const delimiter = detectDelimiter(lines[0]);
    const headers = parseCSVLine(lines[0], delimiter);
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i], delimiter);
        const obj = {};
        headers.forEach((h, idx) => {
            let val = values[idx]?.trim();
            obj[h.toLowerCase()] = val || null;
        });
        if (obj.keimeno && obj.domi && obj.kyrios) data.push(obj);
    }
    return data;
}

async function loadData() {
    const proxies = [
        u => 'https://corsproxy.io/?' + encodeURIComponent(u),
        u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
        u => u
    ];

    for (const p of proxies) {
        try {
            const res = await fetch(p(GOOGLE_SHEET_CSV_URL));
            if (!res.ok) continue;
            const csv = await res.text();
            allData = parseCSV(csv);
            if (allData.length) {
                state.screen = 'selection';
                render();
                return;
            }
        } catch {}
    }
    state.screen = 'selection';
    render();
}
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

/* =====================================================
   FILTERING
===================================================== */

function getFilteredData() {
    let filtered = [...allData];

    if (state.selectedDomiFilter !== 'all') {
        filtered = filtered.filter(i => i.domi === state.selectedDomiFilter);
    }

    if (state.selectedTroposFilter === 'syndyasmos') {
        filtered = filtered.filter(i => i.deytereyon);
    } else if (state.selectedTroposFilter !== 'all') {
        filtered = filtered.filter(i => i.kyrios === state.selectedTroposFilter);
    }

    if (state.selectedDifficulty !== 'all') {
        filtered = filtered.filter(i => i.dyskoleia === state.selectedDifficulty);
    }

    return filtered;
}

/* =====================================================
   RENDER
===================================================== */

function render() {
    const app = document.getElementById('app');
    if (state.screen === 'selection') app.innerHTML = renderSelection();
    else if (state.screen === 'quiz') app.innerHTML = renderQuiz();
    else if (state.screen === 'results') app.innerHTML = renderResults();
    attachEventListeners();
}

/* =====================================================
   CHECK ANSWER  (Î•Î”Î© Î· Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½)
===================================================== */

function checkAnswer() {
    const current = quizData[state.currentQuestion];

    if (state.selectedDomi === current.domi) {
        state.score.domi++;
    } else {
        state.stats.domiErrors++;
    }

    if (state.selectedTropoi[0] === current.kyrios) {
        state.score.tropiKyrios++;
    } else {
        state.stats.kyriosErrors[current.kyrios] =
            (state.stats.kyriosErrors[current.kyrios] || 0) + 1;
    }

    if (current.deytereyon) {
        if (state.selectedTropoi[1] === current.deytereyon) {
            state.score.tropiDeytereyon++;
        } else {
            state.stats.deytereyonErrors++;
        }
    }

    state.showResult = true;
    render();
}

/* =====================================================
   DIAGNOSTIC FEEDBACK  (ÎÎ•ÎŸ)
===================================================== */

function generateDiagnosticFeedback() {
    const messages = [];

    if (state.stats.domiErrors > quizData.length / 2) {
        messages.push("Î”Ï…ÏƒÎºÎ¿Î»ÎµÏÎµÏƒÎ±Î¹ ÏƒÏ„Î· Î´Î¹Î¬ÎºÏÎ¹ÏƒÎ· Î´Î¹Î¼ÎµÏÎ¿ÏÏ‚ ÎºÎ±Î¹ Ï„ÏÎ¹Î¼ÎµÏÎ¿ÏÏ‚ Î´Î¿Î¼Î®Ï‚.");
    }

    const kyriosMistakes = Object.entries(state.stats.kyriosErrors)
        .sort((a, b) => b[1] - a[1]);

    if (kyriosMistakes.length > 0) {
        messages.push(`Î£Ï…Ï‡Î½Î® ÏƒÏÎ³Ï‡Ï…ÏƒÎ· ÏƒÏ„Î¿Î½ Ï„ÏÏŒÏ€Î¿ Î±Î½Î¬Ï€Ï„Ï…Î¾Î·Ï‚: ${kyriosMistakes[0][0]}.`);
    }

    if (state.stats.deytereyonErrors > 0) {
        messages.push("ÎŸ Î´ÎµÏ…Ï„ÎµÏÎµÏÏ‰Î½ Ï„ÏÏŒÏ€Î¿Ï‚ Î±Î½Î¬Ï€Ï„Ï…Î¾Î·Ï‚ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· Ï€ÏÎ¿ÏƒÎ¿Ï‡Î®.");
    }

    return messages;
}

/* =====================================================
   RESULTS (ÎœÎŸÎÎ— Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—: feedback box)
===================================================== */

function renderResults() {
    const maxDomi = quizData.length;
    const maxKyrios = quizData.length;
    const maxDeytereyon = quizData.filter(q => q.deytereyon).length;

    const totalMax = maxDomi + maxKyrios + maxDeytereyon;
    const totalScore = state.score.domi + state.score.tropiKyrios + state.score.tropiDeytereyon;
    const percentage = Math.round((totalScore / totalMax) * 100);

    const diagnostics = generateDiagnosticFeedback();

    return `
    <div class="card results-card">
        <h2 class="results-title">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµÏ‚ Ï„Î¿ Quiz!</h2>

        <div class="results-score-box">
            <p class="results-score">${totalScore} / ${totalMax}</p>
            <p class="results-percentage">(${percentage}%)</p>
        </div>

        ${diagnostics.length ? `
        <div class="feedback-box amber">
            <h4>ğŸ“Œ Î Î±ÏÎ±Ï„Î®ÏÎ·ÏƒÎ· Î³Î¹Î± Ï„Î· Î¼ÎµÎ»Î­Ï„Î· ÏƒÎ¿Ï…</h4>
            ${diagnostics.map(m => `<p>${m}</p>`).join('')}
        </div>
        ` : ''}

        <button class="main-btn primary" id="restartBtn">ÎÎµÎºÎ¯Î½Î± ÎÎ±Î½Î¬</button>
    </div>`;
}

/* =====================================================
   EVENT LISTENERS (ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½)
===================================================== */

function attachEventListeners() {
    const restartBtn = document.getElementById('restartBtn');
    if (restartBtn) {
        restartBtn.onclick = () => {
            quizData = shuffleArray(getFilteredData()).slice(0, state.selectedCount);
            state.currentQuestion = 0;
            state.selectedDomi = null;
            state.selectedTropoi = [];
            state.showResult = false;
            state.score = { domi: 0, tropiKyrios: 0, tropiDeytereyon: 0 };
            state.stats = { domiErrors: 0, kyriosErrors: {}, deytereyonErrors: 0 };
            state.screen = 'quiz';
            render();
        };
    }
}

/* =====================================================
   INIT
===================================================== */

loadData();
</script>
</body>
</html>


